# Диагностика проблемы с получением символов

## Подтвержденные факты:
✅ `utipToken` есть в ответе логина
✅ `utipToken` используется для WebSocket (`wss://dev-virt-point.utip.work/session/${token}?fragment=1`)
✅ WebSocket подключается успешно
✅ Приходят сообщения: `serverName`, `traderType`, `holidays`, `symbolGroups`
❌ НЕ приходит сообщение `symbols`

## Основная гипотеза: Проверка Origin на сервере

Сервер `dev-virt-point.utip.work` может проверять заголовок `Origin` и:
- **В Google AI Studio**: Origin = `https://ai.studio` (или разрешенный домен) → сервер отправляет `symbols`
- **Локально**: Origin = `http://localhost:3000` → сервер блокирует отправку `symbols`

Это объясняет, почему все остальное работает (подключение, другие сообщения), но `symbols` не приходит.

## Что нужно проверить:

### 1. Сравнить Origin заголовки
В Google AI Studio и локально:
- Открыть Network → WS → Headers
- Найти заголовок `Origin`
- Сравнить значения

### 2. Проверить все WebSocket сообщения
В Google AI Studio:
- Посмотреть полную последовательность сообщений после `symbolGroups`
- Приходит ли `optionsSettings`, `optionsSettingsName`, `traderData`, `traderGroup`?
- После каких сообщений приходит `symbols`?
- Сколько времени проходит между `symbolGroups` и `symbols`?

### 3. Проверить, не закрывается ли соединение рано
В коде `SubscriptionContext.tsx`:
- Проверить, не закрывается ли WebSocket до получения `symbols`
- Возможно, `symbols` приходит с задержкой (через 1-2 секунды после `symbolGroups`)

### 4. Попробовать изменить Origin локально
Варианты:
1. Использовать прокси, который меняет Origin
2. Запустить через другой порт/домен
3. Добавить заголовок Origin вручную (если возможно)

### 5. Проверить User-Agent и другие заголовки
Сравнить все заголовки WebSocket запроса между средами

## Временное решение (для тестирования):

Если проблема в Origin, можно:
1. Использовать расширение браузера для изменения Origin
2. Настроить прокси (например, mitmproxy)
3. Развернуть локально через другой домен (например, через hosts файл)

## Дополнительные проверки:

1. **Проверить timeout**: Подождать 5-10 секунд после `symbolGroups`, возможно `symbols` приходит с задержкой
2. **Проверить все сообщения**: Добавить логирование всех WebSocket сообщений, не только `symbols`
3. **Проверить порядок сообщений**: Возможно, `symbols` должен прийти после всех других сообщений



